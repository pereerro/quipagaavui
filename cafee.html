<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Qui paga avui</title>
        <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script>
$(function() {
    $('#dades').on('input', function() {
        inicia();
    });
    $('#pagament').on('click', function() {
        const presa = crea_presa();
        $('#dades').val($('#dades').val()+'\n\n'+presa);
        inicia();
        return false;
    });
    $('#producte').on('change', function(ev) {
        let producte = ev.target.value;
        $('#cost').val('');
        $('#llista option').each(function() {
            const trossos = this.text.split(',');
            if (trossos[1] == producte) {
                $('#cost').val(trossos[2]);
            }
        });
        if (! $('#cost').val() ) {
            get_preses().reverse().forEach(element => {
                let linies = element.split('\n');
                const data = linies[0];
                const paga = linies[1];
                linies.slice(2).forEach(element => {
                    let apunt = get_apunt(element);
                    if (apunt.producte == producte)
                        $('#cost').val(apunt.cost);
                });
            });
        }
        if (! $('#cost').val() ) {
            $('#cost').val('0');
        }
    });
    $('#entra_canvia').on('click', function() {
        let nom = $('#nom').val();
        let producte = $('#producte').val();
        let cost = $('#cost').val();
        let canviat = false;
        $('#llista option').each(function() {
            const trossos = this.text.split(',');
            if (trossos[1] == producte) {
                this.text = trossos[0]+','+producte+','+cost;
            }
            if (nom == trossos[0]) {
                this.text = nom+','+producte+','+cost;
                canviat = true;
            }
        });
        if (! canviat) {
            $('#llista').append('<option>'+nom+','+producte+','+cost+'</option>');
            omple_qui_paga();
        }
        return false;
    });
    $('#llista').on('click', function(ev) {
        omple_qui_paga();
        let apunt = get_apunt(ev.target.text);
        $('#nom').val(apunt.nom);
        $('#producte').val(apunt.producte);
        $('#cost').val(''+apunt.cost);
        var partners = [];
        var deuria_mes = {};
        $('#llista option:selected').each(function() {
            let apunt = get_apunt(this.text);
            partners.push(apunt.nom);
            deuria_mes[apunt.nom] = -apunt.cost;
        });
        var suma_deutes = {};
        var baos = window.balanços;
        partners.forEach(pagaria => {
            suma_deutes[pagaria] = deuria_mes[pagaria];
            partners.forEach(pren => {
                const key = get_key(pagaria,pren);
                if (key in baos) {
                    suma_deutes[pagaria] += baos[key];
                }
            })
        });
        var major_deutor = null;
        var deute_major = null;
        for (const [key, value] of Object.entries(suma_deutes)) {
            if (deute_major == null) {
                major_deutor = key;
                deute_major = value;
            } else {
                if (value < deute_major) {
                    major_deutor = key;
                    deute_major = value;
                }
            }
        }
        $('#qui_paga option').each(function() {
            if (this.text == major_deutor)
                this.setAttribute('selected', true);
            else
                this.removeAttribute('selected');
        });
    });
    inicia();
});

function inicia() {
    window.balanços = get_balanços();
    omple_llista();
}

function omple_qui_paga() {
    $('#qui_paga').empty();
    $('#llista option:selected').each(function() {
        const apunt = get_apunt(this.text);
        $('#qui_paga').append('<option>'+apunt.nom+'</option>');
    });
}

function get_preses() {
    var tot = $('#dades').val();
    var ret = [];
    tot.split('\n\n').forEach(element => {
        const linies = element.split('\n');
        var i = 0;
        var inici = false;
        while ( i < linies.length && ! inici ) {
            if (isNaN(new Date(linies[i]))) {
                i++;
            } else {
                inici = true;
            }
        }
        ret.push(linies.slice(i).join('\n'));
    });
    return ret;
}

function omple_llista() {
    var tot = $('#dades').text();
    var items = {};
    get_preses().forEach(element => {
        let linies = element.split('\n');
        const data = linies[0];
        const paga = linies[1];
        linies.slice(2).forEach(element => {
            let apunt = get_apunt(element);
            if (apunt.nom)
                items[apunt.nom] = element;
        });
    });
    $('#llista').empty();
    for (const [key, value] of Object.entries(items).sort()) {
        $('#llista').append('<option>'+value+'</option>');
    }
    omple_qui_paga();
}

function get_apunt(linia) {
    ret = {};
    const parts = linia.split(',');
    ret.nom = parts[0];
    ret.producte = parts[1];
    ret.cost = parseFloat(parts[2]);
    return ret;
}

function get_key(paga, pren) {
    return paga + '->' + pren;
}

function get_balanços() {
    var baos = {};
    var tot = $('#dades').text();
    get_preses().forEach(element => {
        let linies = element.split('\n');
        const data = linies[0];
        const paga = linies[1];
        linies.slice(2).forEach(element => {
            let apunt = get_apunt(element);
            if (paga != apunt.nom) {
                const k1 = get_key(paga, apunt.nom);
                if (!(k1 in baos))
                    baos[k1] = 0;
                baos[k1] += apunt.cost;
                const k2 = get_key(apunt.nom, paga);
                if (!(k2 in baos))
                    baos[k2] = 0;
                baos[k2] -= apunt.cost;
            }
        });
    });
    $('#balancos').html(JSON.stringify(baos));
    return baos;
}

function crea_presa() {
    var ret = [(new Date()).toISOString()];
    ret.push($('#qui_paga').val());
    $('#llista option:selected').each(function() {
        ret.push(this.text);
    });
    return ret.join('\n');
}

</script>
    </head>
    <body>
        <h1>Qui paga avui</h1>
        <form id="unaltreform">
            <label for="llista">Qui/què pren</label><select id="llista" multiple>
            </select><br />
            <label for="qui_paga">Qui toca pagar</label><select id="qui_paga">
            </select><br />
            <button id="pagament">Pagament</button>
        </form>
        <hr />
        <h2>Entra a la llista</h2>
        <form id="elform">
            <label for="nom">Nom</label>
            <input id="nom"  /><br />
            <label for="producte">Producte</label>
            <select id="producte"><br />
                <option>Cafè</option>
                <option>Tallat</option>
                <option>Cafè amb llet</option>
                <option>Té</option>
                <option>Res</option>
            </select><br />
            <label for="cost">Cost</label><input type="number" step="any" id="cost" /><br />
            <button id="entra_canvia">Entra o canvia</button>
        </form>
        <hr />
        <div>
            <h2>Historial</h2>
<textarea id="dades"></textarea>
        </div>
        <div id="balancos">
        </div>
    </body>
</html>
